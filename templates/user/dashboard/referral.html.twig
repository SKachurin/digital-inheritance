{% extends 'user/dashboard/layout.html.twig' %}

{% block dashboard_main %}
    <div class="transactions-section">
        <h2>{{ 'dashboard.ref.title'|trans }}</h2>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <div class="transaction-card">
            <section class="mb-4">
                <div class="tooltip-box">{{ 'dashboard.ref.intro'|trans |raw }}</div>
            </section>

            <div class="referral-stats">
                <div class="stat-card">
                    <div class="stat-value">{{ customerReferralCount|default(0) }}</div>
                    <div class="stat-label">{{ 'dashboard.ref.total_invited'|trans }}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-value">{{ customerActiveReferralsCount |default(0) }}</div>
                    <div class="stat-label">{{ 'dashboard.ref.still_paid'|trans }}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-value">{{ rewardsEarned|default('Check') }}</div>
                    <div class="stat-label">{{ 'dashboard.ref.your_balance'|trans }}</div>

                    <a class="btn btn-outline-dark btn-floating m-1 mt-4"
                       href="{{ path('user_home_ref', { checkBalance: 1 }) }}"
                       role="button">
                        <i>{{ 'dashboard.ref.check_balance'|trans }}</i>
                    </a>
                </div>

                <div class="stat-card">
                    <div id='link' class="stat-value">
                        <input type="text" id="referral-link" class="form-control"
                               value="{{ YourReferralLink }}" readonly />
                    </div>
                    <div class="stat-label">{{ 'dashboard.ref.ref_link'|trans }}</div>

                    <a class="btn btn-outline-dark btn-floating m-1 mt-4"
                       href="#"
                       role="button"
                       onclick="copyReferralLink(event)">
                        <i class="">{{ 'dashboard.ref.copy_link'|trans }}</i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <style>
        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        #link {
            font-size: 14px;
        }

        #referral-link {
            color: #3182CE;
            font-weight: bold;
            margin-bottom: 1.3em;
        }
    </style>


    <script>
        function copyReferralLink(event) {
            event.preventDefault();
            const linkInput = document.getElementById('referral-link');
            if (!linkInput) return;
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // for mobile

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                }).catch(err => {
                    console.error('Clipboard API failed, using fallback', err);
                    document.execCommand('copy');
                });
            } else {
                // Fallback for older browsers
                document.execCommand('copy');
            }
        }
    </script>
{% endblock %}
