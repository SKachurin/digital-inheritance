{% extends '/user/dashboard/layout.html.twig' %}
{% block dashboard_main %}
    <style>
        .form-container {
            padding-top: 4em;
        }
        .form-header {
            margin-bottom: 1em;
        }
        .button-group {
            display: flex;
            align-items: center;
            margin-top: 0.5em;
        }
        .button-group a {
            margin-left: 1em;
        }
        .divider {
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }
        .divider::before,
        .divider::after {
            flex: 1;
            content: '';
            padding: 1px;
            background-color: #bbbb;
            margin: 2em !important;
        }
        #box {
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
            background: rgba(255, 255, 255, .9);
            transition: background-color .3s ease;
        }
        #box:hover {
            background-color: #e9ecef;
        }

        #encrypting-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, .9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 6px solid #ccc;
            border-top: 6px solid #333;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <div class="transactions-section">
        <h2 style="padding-top: 2em;">{{ 'dashboard.create_your_secure_envelope'|trans }}</h2>
        <p>{{ 'create_your_secure_envelope_text'|trans|raw }}</p>

        <div class="tooltip_text mb-4">{{ 'dashboard.create_your_secure_envelope_tip'|trans }}</div>

        <!-- Toggle Encrypt in Browser (Default On) -->
        <div class="form-check form-switch mb-4">
            <input class="form-check-input" type="checkbox" id="frontendEncrypted" checked>
            <label class="form-check-label" for="frontendEncrypted">
                {{ 'dashboard.create_your_secure_envelope_switch'|trans|raw }}
            </label>
        </div>

        {{ form_start(form) }}
        {{ form_row(form.customerText) }}

        <div class="divider">{{ 'your_questions'|trans }}</div>
        <p>{{ 'your_questions_explain'|trans }}</p>
        {{ form_row(form.customerFirstQuestion) }}
        {{ form_row(form.customerFirstQuestionAnswer) }}
        {{ form_row(form.customerSecondQuestion) }}
        {{ form_row(form.customerSecondQuestionAnswer) }}

        {{ form_row(form._token) }}

        <div class="divider">{{ 'heir_questions'|trans }}</div>
        <p>{{ 'heir_questions_explain'|trans }}</p>

        <script src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"></script>
        <script>
            async function sha256_b64_utf8(str) {
                const data = new TextEncoder().encode(str);
                const buf  = await crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode(...new Uint8Array(buf)));
            }
        </script>
        <script>
            /** DEBUG SWITCH: set to false after you find the issue **/
            const DEBUG_MODE = true;

            (function () {
                // const say = (m) => { try { alert(m); } catch(e) {} console.log(m); };
                // window.onerror = function(msg, src, line, col, err){
                //     say('DBG ERR: ' + msg + ' @ ' + (src||'inline') + ':' + line + ':' + col + (err ? (' | ' + (err.stack||err)) : ''));
                // };
                //
                // say('DBG#1 inline JS loaded');

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', boot);
                } else {
                    boot();
                }

                function boot(){
                    // say('DBG#2 DOM ready');

                    // ---- find form & critical nodes
                    const formName = "{{ form.vars.name }}";
                    const form = document.querySelector('form[name="{{ form.vars.name }}"]');
                    // say('DBG#3 form found? ' + !!form + ' (name=' + formName + ')');

                    const overlay = document.getElementById('encrypting-overlay');
                    // say('DBG#4 overlay found? ' + !!overlay);

                    const toggle = document.getElementById('frontendEncrypted');
                    // say('DBG#5 toggle found? ' + !!toggle + (toggle ? ' checked=' + toggle.checked : ''));

                    if (!form) { say('DBG! no form node; abort'); return; }

                    // ---- small helpers
                    function b64FromBytes(bytes){ return btoa(String.fromCharCode(...bytes)); }
                    async function genDEK(){
                        const raw = crypto.getRandomValues(new Uint8Array(32));               // keep these for KMS wrap
                        const key = await crypto.subtle.importKey('raw', raw, 'AES-GCM', false, ['encrypt','decrypt']); // non-extractable is fine
                        return { key, raw };                                                   // no exportKey()
                    }
                    async function aesGcmEncRaw(key, plaintext){
                        const iv = crypto.getRandomValues(new Uint8Array(12));
                        const enc = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(plaintext));
                        return { c_b64: b64FromBytes(new Uint8Array(enc)), iv_b64: b64FromBytes(iv) };
                    }
                    async function argonH(answer){
                        const salt = crypto.getRandomValues(new Uint8Array(16));
                        const r = await argon2.hash({
                            pass: new TextEncoder().encode(answer),
                            salt,
                            time: 5, mem: 65536, parallelism: 1, hashLen: 32,
                            type: argon2.ArgonType.Argon2id, raw: true
                        });
                        return { h: new Uint8Array(r.hash), salt };
                    }
                    async function wrapWithKMS(kmsId, dekRawB64, hB64, answer_fp) {
                        try {
                            const res = await fetch('/api/kms/wrap', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                credentials: 'same-origin',
                                body: JSON.stringify({ kms_id: "kms" + kmsId, dek_b64: dekRawB64, h_b64: hB64, answer_fp })
                            });

                            const j = await res.json().catch(() => null);

                            // Any non-200 or missing w_b64 = "no replica for this KMS"
                            if (!res.ok || !j || !j.w_b64) {
                                console.warn('KMS wrap failed for KMS', kmsId, res.status, j);
                                return null;
                            }

                            return j.w_b64;
                        } catch (e) {
                            console.warn('KMS wrap exception for KMS', kmsId, e);
                            return null;
                        }
                    }
                    function setHidden(name, val){
                        let el = form.querySelector('[name="'+name.replace(/"/g,'\\"')+'"]');
                        if (!el) { el = document.createElement('input'); el.type='hidden'; el.name=name; form.appendChild(el); }
                        el.value = val;
                        // say(`DBG#H set hidden "${name}" len=${String(val).length}`);
                    }

                    // ---- attach submit
                    form.addEventListener('submit', async function onSubmit(ev){
                        // say('DBG#6 submit fired');

                        try {
                            if (!toggle) {
                                // say('DBG#7 no toggle → proceed server path');
                                return;
                            }
                            // say('DBG#8 toggle.checked=' + toggle.checked);
                            if (!toggle.checked) {
                                // say('DBG#9 FE encrypt OFF → normal submit');
                                return;
                            }

                            if (DEBUG_MODE) {
                                ev.preventDefault();
                                // say('DBG#10 preventDefault (DEBUG_MODE)');
                            }

                            if (overlay) {
                                overlay.style.display = 'flex';
                                // say('DBG#11 overlay shown');
                            }

                            // ---- read fields
                            const noteElId = "{{ form.customerText.vars.id }}";
                            const a1Id     = "{{ form.customerFirstQuestionAnswer.vars.id }}_first";
                            const a1rId    = "{{ form.customerFirstQuestionAnswer.vars.id }}_second";
                            const a2Id     = "{{ form.customerSecondQuestionAnswer.vars.id }}_first";
                            const b1Id     = "{{ form.beneficiaryFirstQuestionAnswer.vars.id }}_first";
                            const b1rId    = "{{ form.beneficiaryFirstQuestionAnswer.vars.id }}_second";
                            const b2Id     = "{{ form.beneficiarySecondQuestionAnswer.vars.id }}_first";

                            const noteEl = document.getElementById(noteElId);
                            const a1El   = document.getElementById(a1Id);
                            const a1rEl  = document.getElementById(a1rId);
                            const a2El   = document.getElementById(a2Id);
                            const b1El   = document.getElementById(b1Id);
                            const b1rEl  = document.getElementById(b1rId);
                            const b2El   = document.getElementById(b2Id);

                            // say(`DBG#12 fields present note=${!!noteEl} a1=${!!a1El} a1r=${!!a1rEl} a2=${!!a2El} b1=${!!b1El} b1r=${!!b1rEl} b2=${!!b2El}`);

                            const note = noteEl ? noteEl.value : '';
                            const a1   = a1El ? a1El.value : '';
                            const a1r  = a1rEl ? a1rEl.value : '';
                            const a2   = a2El ? a2El.value : '';
                            const b1   = b1El ? b1El.value : '';
                            const b1r  = b1rEl ? b1rEl.value : '';
                            const b2   = b2El ? b2El.value : '';

                            // say(`DBG#13 lengths note=${note.length} a1=${a1.length} a1r=${a1r.length} a2=${a2.length} b1=${b1.length} b1r=${b1r.length} b2=${b2.length}`);
                            // say(`DBG#14 first10 note="${note.slice(0,10)}" a1="${a1.slice(0,10)}" b1="${b1.slice(0,10)}"`);

                            if (a1 && a1r && a1 !== a1r) {
                                // say('DBG! A1 mismatch');
                                if (!DEBUG_MODE) return;
                            }
                            if (b1 && b1r && b1 !== b1r) {
                                // say('DBG! B1 mismatch');
                                if (!DEBUG_MODE) return;
                            }

                            if (!note || !a1 || !b1) {
                                // say('DBG#15 missing required (note/a1/b1). Fallback to server submit.');
                                if (overlay) overlay.style.display = 'none';
                                if (DEBUG_MODE) { form.submit(); }
                                return;
                            }

                            // ---- WebCrypto presence
                            if (!crypto || !crypto.subtle) {
                                // say('DBG! WebCrypto missing');
                                return;
                            }
                            // say('DBG#16 WebCrypto OK');

                            // ---- DEK + encrypt
                            // say('DBG#17 genDEK start');
                            const { key: dekKey, raw: dekRaw } = await genDEK();
                            // say('DBG#18 DEK raw length=' + dekRaw.length);

                            // say('DBG#19 AES-GCM encrypt start');
                            const enc = await aesGcmEncRaw(dekKey, note);
                            // say('DBG#20 enc.c_b64 len=' + enc.c_b64.length + ' iv_b64=' + enc.iv_b64);

                            // ---- per-answer wrap
                            const NAMES = {
                                a1: ["{{ form.customerTextAnswerOne.vars.full_name }}","{{ form.customerTextAnswerOneKms2.vars.full_name }}","{{ form.customerTextAnswerOneKms3.vars.full_name }}"],
                                a2: ["{{ form.customerTextAnswerTwo.vars.full_name }}","{{ form.customerTextAnswerTwoKms2.vars.full_name }}","{{ form.customerTextAnswerTwoKms3.vars.full_name }}"],
                                b1: ["{{ form.beneficiaryTextAnswerOne.vars.full_name }}","{{ form.beneficiaryTextAnswerOneKms2.vars.full_name }}","{{ form.beneficiaryTextAnswerOneKms3.vars.full_name }}"],
                                b2: ["{{ form.beneficiaryTextAnswerTwo.vars.full_name }}","{{ form.beneficiaryTextAnswerTwoKms2.vars.full_name }}","{{ form.beneficiaryTextAnswerTwoKms3.vars.full_name }}"],
                            };
                            const answers = { a1, a2, b1, b2 };

                            // flag that FE encryption happened
                            setHidden("{{ form.frontendEncrypted.vars.full_name }}", '1');

                            const dekB64 = b64FromBytes(dekRaw);
                            let anyWrapSucceeded = false; // track global success across all answers/KMS

                            for (const [slot, val] of Object.entries(answers)) {
                                if (!val) {
                                    // say(`DBG#21 skip slot ${slot} (empty)`);
                                    continue;
                                }

                                // say(`DBG#22 Argon2 start for ${slot}`);
                                const { h, salt } = await argonH(val);
                                const hB64 = b64FromBytes(h);
                                const sB64 = b64FromBytes(salt);
                                // say(`DBG#23 Argon2 ok ${slot}: h.len=${h.length} salt_b64=${sB64}`);

                                for (let i = 0; i < 3; i++) {
                                    const kmsId = i + 1;
                                    const answer_fp = await sha256_b64_utf8(`${enc.c_b64}.${enc.iv_b64}.${sB64}`);
                                    // say(`DBG#24 wrap start ${slot} KMS${kmsId}`);
                                    const w_b64 = await wrapWithKMS(kmsId, dekB64, hB64, answer_fp);

                                    // If this KMS didn't wrap, DO NOT create a JSON blob for it
                                    if (!w_b64) {
                                        // KMS for this replica is unavailable -> DB field should stay NULL
                                        continue;
                                    }

                                    anyWrapSucceeded = true;

                                    const payload = JSON.stringify({
                                        kms_id: "kms" + kmsId,      // "kms1", "kms2", "kms3"
                                        c: enc.c_b64,
                                        iv: enc.iv_b64,
                                        w: w_b64,
                                        s: sB64
                                    });
                                    const hiddenName = NAMES[slot][i];
                                    setHidden(hiddenName, payload);
                                    // say(`DBG#25 set payload ${slot}/KMS${kmsId} len=${payload.length} -> name="${hiddenName}"`);
                                }
                            }

                            // say('DBG#26 done building payloads');
                            // if (overlay) say('DBG#27 leaving overlay visible until submit');

                            if (DEBUG_MODE) {
                                // say('DBG#28 DEBUG submit now');
                                form.submit();
                            }
                        } catch (ex) {
                            alert('Encryption failed: ' + (ex && ex.message || ex));
                            if (overlay) overlay.style.display = 'none';
                            // DO NOT submit here. Investigate instead.
                        }
                    });

                    // say('DBG#29 submit listener attached');
                }
            })();
        </script>



        {{ form_end(form) }}
    </div>

    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}

    <div id="encrypting-overlay">
        <div class="overlay-content" style="text-align:center;">
            <h2>{{ 'overlay_encrypting'|trans }} </h2>
            <p>{{ 'overlay_wait'|trans }} </p>
            <div class="spinner"></div>
        </div>
    </div>
{% endblock %}
